<!DOCTYPE html>
<html lang="km">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á…á¼á›ášá½á˜á…á¶á”áŸ‹ášá„áŸ’áœá¶á“áŸ‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', 'Kantumruy Pro', sans-serif;
            /* Background image styling */
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('lucky pic.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white text-gray-900 rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md my-8">

        <h1 class="text-2xl sm:text-3xl font-extrabold text-center mb-4 bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-purple-500">
            á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á…á¼á›ášá½á˜
        </h1>
        <p class="text-center text-gray-600 mb-6 text-sm">áŸá¼á˜á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹ á“á·á„á—áŸ’á‡á¶á”áŸ‹áœá·á€áŸá™á”ááŸ’ášáŠá¾á˜áŸ’á”á¸á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡áŸ”</p>

        <!-- Payment Options Container -->
        <div class="space-y-4 mb-6">

            <!-- 1. ABA BANK Section -->
            <div class="bg-[#005F92] rounded-xl p-5 text-white shadow-lg relative overflow-hidden">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold text-lg tracking-wider">ABA BANK</span>
                    <span class="text-xs bg-white text-[#005F92] px-2 py-1 rounded font-bold">PAY</span>
                </div>
                <div class="flex justify-center mb-4">
                    <div class="bg-white p-2 rounded-lg shadow-md">
                        <img src="Qr AbA.jpg" alt="ABA QR Code" class="w-24 h-24 object-contain">
                    </div>
                </div>
                <div class="space-y-1 text-center">
                    <p class="text-xs opacity-80">Account Number</p>
                    <p class="text-xl font-mono font-bold tracking-widest select-all">004 255 933</p>
                    <p class="text-base font-semibold uppercase tracking-wide mt-1">LYSONGENG</p>
                </div>
            </div>

            <!-- 2. ACLEDA BANK Section -->
            <div class="bg-[#0E336A] rounded-xl p-5 text-white shadow-lg relative overflow-hidden border border-gray-200">
                <div class="absolute -left-6 -bottom-6 w-24 h-24 bg-white opacity-10 rounded-full"></div>
                <div class="flex justify-between items-center mb-4">
                    <span class="font-bold text-lg tracking-wider">ACLEDA</span>
                    <span class="text-xs bg-[#FDB913] text-[#0E336A] px-2 py-1 rounded font-bold">KHQR</span>
                </div>
                <div class="flex justify-center mb-4">
                    <div class="bg-white p-2 rounded-lg shadow-md">
                        <img src="Ac.jpg.jpg" alt="ACLEDA QR Code" class="w-24 h-24 object-contain">
                    </div>
                </div>
                <div class="space-y-1 text-center">
                    <p class="text-xs opacity-80">Phone/Account Number</p>
                    <p class="text-xl font-mono font-bold tracking-widest select-all">077 772 604</p>
                    <p class="text-base font-semibold uppercase tracking-wide mt-1">HOK SAN PANHA</p>
                </div>
            </div>

        </div>

        <!-- Name Input -->
        <div class="mb-4">
            <label for="nameInput" class="block text-sm font-medium text-gray-700 mb-2">á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€</label>
            <input type="text" id="nameInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="á§. áŸá»á áœááŸ’áá¶">
        </div>

        <!-- NEW: Upload Receipt Section -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">á”á‰áŸ’á…á¼á›ášá¼á”á—á¶á–áœá·á€áŸá™á”ááŸ’áš (Upload Payment Slip)</label>
            <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-blue-500 transition-colors bg-gray-50 relative">
                <div class="space-y-1 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <div class="flex text-sm text-gray-600 justify-center">
                        <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-blue-600 hover:text-blue-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-blue-500">
                            <span>á…á»á…áŠá¾á˜áŸ’á”á¸á‡áŸ’ášá¾áŸášá¾áŸášá¼á”á—á¶á–</span>
                            <input id="file-upload" name="file-upload" type="file" accept="image/*" class="sr-only">
                        </label>
                    </div>
                    <p class="text-xs text-gray-500">PNG, JPG, GIF up to 5MB</p>
                </div>
                <!-- Image Preview -->
                <img id="image-preview" class="hidden absolute inset-0 w-full h-full object-contain bg-white rounded-lg p-1" />
            </div>
            <p id="file-name" class="mt-2 text-sm text-gray-500 text-center"></p>
        </div>

        <!-- Payment Confirmation Checkbox -->
        <div class="mb-6 flex items-start gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
            <input type="checkbox" id="paymentCheck" class="w-5 h-5 mt-0.5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 cursor-pointer">
            <label for="paymentCheck" class="text-sm text-gray-700 cursor-pointer select-none">
                ááŸ’á‰á»áŸ†á”á¶á“á’áŸ’áœá¾á€á¶ášá•áŸ’á‘áŸášá”áŸ’ášá¶á€áŸ‹ á“á·á„á—áŸ’á‡á¶á”áŸ‹áœá·á€áŸá™á”ááŸ’ášááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”
            </label>
        </div>

        <!-- Submit Button -->
        <button id="submitButton" disabled class="w-full bg-gray-400 text-white p-3 rounded-lg text-lg font-bold transition duration-300 shadow-lg cursor-not-allowed flex justify-center items-center gap-2">
            <span>á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡</span>
            <svg id="loadingIcon" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        </button>

        <!-- Message Display -->
        <div id="messageDisplay" class="mt-4 text-center font-medium min-h-[24px]"></div>

    </div>

    <script>
        const nameInput = document.getElementById('nameInput');
        const submitButton = document.getElementById('submitButton');
        const messageDisplay = document.getElementById('messageDisplay');
        const paymentCheck = document.getElementById('paymentCheck');
        const fileUpload = document.getElementById('file-upload');
        const imagePreview = document.getElementById('image-preview');
        const fileNameDisplay = document.getElementById('file-name');
        const loadingIcon = document.getElementById('loadingIcon');

        // This is the shared key between client and admin
        const PARTICIPANT_STORAGE_KEY = 'luckyDrawParticipants';

        // Telegram Bot Configuration
        const telegram_bot_id = "8273106488:AAHHTDMqoZemCK563T-YQMB4arMYl5Ntq-w";
        const chat_id = 1126254088;

        // Handle File Selection and Preview
        fileUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
                fileNameDisplay.textContent = `á”á¶á“á‡áŸ’ášá¾áŸášá¾áŸ: ${file.name}`;
            } else {
                imagePreview.classList.add('hidden');
                imagePreview.src = '';
                fileNameDisplay.textContent = '';
            }
        });

        // Toggle button state based on checkbox
        paymentCheck.addEventListener('change', function() {
            updateButtonState();
        });

        function updateButtonState() {
            if (paymentCheck.checked) {
                submitButton.disabled = false;
                submitButton.classList.remove('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            } else {
                submitButton.disabled = true;
                submitButton.classList.add('bg-gray-400', 'cursor-not-allowed');
                submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            }
        }

        // NEW: Function to send PHOTO to Telegram
        async function sendToTelegramWithPhoto(name, file) {
            const caption = `ğŸ’¸ <b>á€á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡ááŸ’á˜á¸ (New Payment)</b> ğŸ’¸\n\n<b>áˆáŸ’á˜áŸ„áŸ‡:</b> ${name}\n<b>áŸáŸ’áá¶á“á—á¶á–:</b> á”á¶á“á—áŸ’á‡á¶á”áŸ‹áœá·á€áŸá™á”ááŸ’áš (Slip Uploaded)\n\náŸá¼á˜á–á·á“á·ááŸ’á™á˜á¾á›ášá¼á”á—á¶á–áœá·á€áŸá™á”ááŸ’ášáá¶á„á›á¾áŸ”`;

            const formData = new FormData();
            formData.append('chat_id', chat_id);
            formData.append('caption', caption);
            formData.append('parse_mode', 'HTML');
            formData.append('photo', file); // Append the file object

            try {
                const response = await fetch(`https://api.telegram.org/bot${telegram_bot_id}/sendPhoto`, {
                    method: 'POST',
                    body: formData
                });
                return await response.json();
            } catch (error) {
                console.error('Error sending photo to Telegram:', error);
                return {
                    ok: false
                };
            }
        }

        // Fallback: Send Text Message only
        async function sendToTelegramTextOnly(messageText) {
            const url = `https://api.telegram.org/bot${telegram_bot_id}/sendMessage`;
            const payload = {
                chat_id: chat_id,
                text: messageText,
                parse_mode: 'HTML'
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                console.error('Error sending text to Telegram:', error);
                return {
                    ok: false
                };
            }
        }

        async function registerName() {
            const name = nameInput.value.trim();
            const file = fileUpload.files[0];

            if (!name) {
                messageDisplay.textContent = 'áŸá¼á˜á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡ášá”áŸáŸ‹á¢áŸ’á“á€!';
                messageDisplay.className = 'mt-4 text-center font-medium text-red-600';
                return;
            }

            if (!paymentCheck.checked) {
                messageDisplay.textContent = 'áŸá¼á˜á”á‰áŸ’á‡á¶á€áŸ‹áá¶á¢áŸ’á“á€á”á¶á“á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹ášá½á…ášá¶á›áŸ‹!';
                messageDisplay.className = 'mt-4 text-center font-medium text-red-600';
                return;
            }

            // Show loading state
            submitButton.disabled = true;
            loadingIcon.classList.remove('hidden');
            messageDisplay.textContent = 'á€áŸ†á–á»á„á•áŸ’á‰á¾á‘á·á“áŸ’á“á“áŸá™...';
            messageDisplay.className = 'mt-4 text-center font-medium text-blue-600';

            try {
                let names = JSON.parse(localStorage.getItem(PARTICIPANT_STORAGE_KEY)) || [];

                const nameExists = names.some(existingName => existingName.toLowerCase() === name.toLowerCase());

                if (nameExists) {
                    messageDisplay.textContent = 'áˆáŸ’á˜áŸ„áŸ‡á“áŸáŸ‡á”á¶á“á…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡ášá½á…ášá¶á›áŸ‹á á¾á™áŸ”';
                    messageDisplay.className = 'mt-4 text-center font-medium text-yellow-600';
                } else {
                    // 1. Send to Telegram
                    if (file) {
                        await sendToTelegramWithPhoto(name, file);
                    } else {
                        const telegramMessage = `ğŸ’¸ <b>á€á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡ááŸ’á˜á¸</b> ğŸ’¸\n\n<b>áˆáŸ’á˜áŸ„áŸ‡:</b> ${name}\n<b>áŸáŸ’áá¶á“á—á¶á–:</b> á˜á·á“á”á¶á“á—áŸ’á‡á¶á”áŸ‹áœá·á€áŸá™á”ááŸ’áš (No Slip)\n\náŸá¼á˜á‘á¶á€áŸ‹á‘á„á¢áá·áá·á‡á“áŸ”`;
                        await sendToTelegramTextOnly(telegramMessage);
                    }

                    // 2. Save to LocalStorage
                    names.push(name);
                    localStorage.setItem(PARTICIPANT_STORAGE_KEY, JSON.stringify(names));

                    messageDisplay.textContent = 'á€á¶ášá…á»áŸ‡áˆáŸ’á˜áŸ„áŸ‡á”á¶á“á‡áŸ„á‚á‡áŸá™! áŸá¼á˜ášá„áŸ‹á…á¶áŸ†á€á¶ášá…á¶á”áŸ‹ášá„áŸ’áœá¶á“áŸ‹áŸ”';
                    messageDisplay.className = 'mt-4 text-center font-medium text-green-600';

                    // Reset form
                    nameInput.value = '';
                    paymentCheck.checked = false;
                    fileUpload.value = ''; // Clear file input
                    imagePreview.src = '';
                    imagePreview.classList.add('hidden');
                    fileNameDisplay.textContent = '';
                }
            } catch (e) {
                console.error("Error", e);
                messageDisplay.textContent = 'á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á‘á·á“áŸ’á“á“áŸá™áŸ”';
                messageDisplay.className = 'mt-4 text-center font-medium text-red-600';
            } finally {
                // Reset loading state
                loadingIcon.classList.add('hidden');
                updateButtonState(); // Re-enable if checked (though we unchecked it above, so it will stay disabled until checked again)
            }

            setTimeout(() => {
                messageDisplay.textContent = '';
            }, 5000);
        }

        submitButton.addEventListener('click', registerName);
        nameInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !submitButton.disabled) {
                registerName();
            }
        });
    </script>

</body>

</html>